version: 1
backend:
  phases:
    preBuild:
      commands:
        # Configurar entorno Node.js
        - nvm install 18.18.2
        - nvm use 18.18.2
        - npm install -g npm@9.8.1

        # Instalar dependencias globales necesarias
        - npm install -g @aws-amplify/cli@latest @aws-amplify/backend-cli@latest

        # Instalar dependencias del proyecto
        - npm install --legacy-peer-deps @aws-amplify/backend @aws-amplify/data-schema

    build:
      commands:
        # Generar outputs y desplegar
        - npx ampx generate
        - npx ampx deploy --app-id $AMPLIFY_APP_ID --branch $AMPLIFY_BRANCH

frontend:
  phases:
    preBuild:
      commands:
        - npm ci --legacy-peer-deps --prefer-offline
    build:
      commands:
        - npm run build-prod
  artifacts:
    baseDirectory: dist/poc-amplify-angular/browser
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
      - .amplify/**/*
